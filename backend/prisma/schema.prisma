generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  role          String    // CLIENTE, GRUERO, ADMIN
  nombre        String
  apellido      String
  telefono      String
  rut           String?   @unique
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  clienteProfile   Cliente?
  grueroProfile    Gruero?
  securityLogs     SecurityLog[]
  
  @@map("users")
}

model Cliente {
  id              String    @id @default(uuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Suspensión de cuenta
  cuentaSuspendida  Boolean   @default(false)
  motivoSuspension  String?
  
  servicios       Servicio[]
  calificacionesDadas  Calificacion[] @relation("CalificacionesCliente")
  
  @@map("clientes")
}

model Gruero {
  id                    String         @id @default(uuid())
  userId                String         @unique
  user                  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Información del vehículo
  patente               String         @unique
  marca                 String
  modelo                String
  anio                  Int
  tipoGrua              String         @default("CAMA_BAJA") // CAMA_BAJA, HORQUILLA, PLUMA
  capacidadToneladas    Float
  tiposVehiculosAtiende String         @default("[]") // JSON array: ["AUTOMOVIL", "SUV", "CAMION_LIVIANO", etc]
  
  // Ubicación y estado
  status                String         @default("OFFLINE") // DISPONIBLE, OCUPADO, OFFLINE, SUSPENDIDO
  latitud               Float?
  longitud              Float?
  
  // Verificación y suspensión
  verificado            Boolean        @default(false)
  estadoVerificacion    String         @default("PENDIENTE") // PENDIENTE, APROBADO, RECHAZADO
  motivoRechazo         String?
  cuentaSuspendida      Boolean        @default(false)
  motivoSuspension      String?
  
  // Estadísticas
  totalServicios        Int            @default(0)
  calificacionPromedio  Float          @default(0)
  
  // Relaciones
  servicios             Servicio[]
  calificacionesRecibidas Calificacion[] @relation("CalificacionesGruero")
  
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt @default(now())
  
  @@map("grueros")
}

model Servicio {
  id                String         @id @default(uuid())
  
  clienteId         String
  cliente           Cliente        @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  
  grueroId          String?
  gruero            Gruero?        @relation(fields: [grueroId], references: [id], onDelete: SetNull)
  
  origenLat         Float
  origenLng         Float
  origenDireccion   String
  
  destinoLat        Float
  destinoLng        Float
  destinoDireccion  String
  
  tipoVehiculo      String         @default("AUTOMOVIL") // AUTOMOVIL, SUV, CAMION_LIVIANO, etc
  
  distanciaKm       Float
  tarifaBase        Float
  tarifaDistancia   Float
  subtotal          Float
  comisionPlataforma Float
  comisionMP        Float
  totalCliente      Float
  totalGruero       Float
  
  status            String         @default("SOLICITADO") // SOLICITADO, ACEPTADO, EN_CAMINO, EN_SITIO, COMPLETADO, CANCELADO
  
  solicitadoAt      DateTime       @default(now())
  aceptadoAt        DateTime?
  enCaminoAt        DateTime?
  enSitioAt         DateTime?
  completadoAt      DateTime?
  canceladoAt       DateTime?
  
  observaciones     String?
  motivoCancelacion String?
  
  pagado            Boolean        @default(false)
  
  // Mercado Pago
  mpPreferenceId    String?
  mpPaymentId       String?
  
  calificacion      Calificacion?
  reclamos          Reclamo[]

  @@map("servicios")
}

model Calificacion {
  id            String    @id @default(uuid())
  
  servicioId    String    @unique
  servicio      Servicio  @relation(fields: [servicioId], references: [id], onDelete: Cascade)
  
  clienteId     String
  cliente       Cliente   @relation("CalificacionesCliente", fields: [clienteId], references: [id], onDelete: Cascade)
  
  grueroId      String
  gruero        Gruero    @relation("CalificacionesGruero", fields: [grueroId], references: [id], onDelete: Cascade)
  
  puntuacionGruero  Int
  comentarioGruero  String?
  
  puntuacionCliente Int
  comentarioCliente String?
  
  createdAt     DateTime  @default(now())
  
  @@map("calificaciones")
}

model Reclamo {
  id              String    @id @default(uuid())
  servicioId      String
  servicio        Servicio  @relation(fields: [servicioId], references: [id], onDelete: Cascade)
  
  // Tipo y descripción
  tipo            String    // PROBLEMA_SERVICIO, PROBLEMA_PAGO, MALTRATO, OTRO
  descripcion     String
  
  // Estado y prioridad
  estado          String    @default("PENDIENTE") // PENDIENTE, EN_REVISION, RESUELTO, RECHAZADO
  prioridad       String    @default("MEDIA") // BAJA, MEDIA, ALTA
  
  // Quién reporta
  reportadoPor    String    // CLIENTE, GRUERO
  reportadorId    String    // userId del que reporta
  
  // Resolución
  resolucion      String?
  resueltoAt      DateTime?
  resueltoBy      String?   // adminId que resolvió
  
  // Adjuntos y notas
  adjuntos        String?   // JSON array de URLs
  notasInternas   String?   // Notas del admin
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("reclamos")
}

model Admin {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  nombre        String
  apellido      String
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("admins")
}

model Notificacion {
  id          String    @id @default(uuid())
  userId      String
  tipo        String    // NUEVO_SERVICIO, SERVICIO_ACEPTADO, EN_CAMINO, EN_SITIO, COMPLETADO, CANCELADO, CALIFICACION
  titulo      String
  mensaje     String
  leida       Boolean   @default(false)
  data        String?   // JSON con datos adicionales (servicioId, distancia, grueroId, etc)
  referencia  String?
  createdAt   DateTime  @default(now())
  
  @@index([userId, leida])
  @@index([createdAt])
  @@map("notificaciones")
}

model SecurityLog {
  id          String   @id @default(uuid())
  tipo        SecurityEventType
  nivel       SecurityLevel
  ip          String
  userAgent   String?
  userId      String?
  email       String?
  endpoint    String
  method      String
  statusCode  Int?
  mensaje     String
  metadata    Json?
  createdAt   DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tipo])
  @@index([nivel])
  @@index([ip])
  @@index([userId])
  @@index([createdAt])
  @@map("security_logs")
}

model IPBlacklist {
  id             String    @id @default(uuid())
  ip             String    @unique
  razon          String    // "AUTO_BLOCKED", "MANUAL", "SUSPICIOUS_ACTIVITY"
  intentos       Int       @default(0)
  bloqueadoAt    DateTime  @default(now())
  desbloqueadoAt DateTime?
  permanente     Boolean   @default(false)
  notas          String?
  createdBy      String?   // Admin que bloqueó manualmente
  
  @@index([ip])
  @@index([bloqueadoAt])
  @@map("ip_blacklist")
}

model IPWhitelist {
  id          String   @id @default(uuid())
  ip          String   @unique
  descripcion String   // "Oficina Santiago", "VPN Empresa", etc
  createdBy   String
  createdAt   DateTime @default(now())
  
  @@index([ip])
  @@map("ip_whitelist")
}

enum SecurityEventType {
  LOGIN_FAILED
  LOGIN_SUCCESS
  REGISTER_FAILED
  REGISTER_SUCCESS
  PASSWORD_CHANGE_FAILED
  PASSWORD_CHANGE_SUCCESS
  VALIDATION_ERROR
  RATE_LIMIT_EXCEEDED
  SUSPICIOUS_REQUEST
  XSS_ATTEMPT
  SQL_INJECTION_ATTEMPT
  UNAUTHORIZED_ACCESS
  TOKEN_EXPIRED
  TOKEN_INVALID
  ACCOUNT_DELETED
  ACCOUNT_SUSPENDED
}

enum SecurityLevel {
  INFO
  WARNING
  DANGER
  CRITICAL
}

model PasswordReset {
  id        String   @id @default(uuid())
  email     String
  code      String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([code])
}